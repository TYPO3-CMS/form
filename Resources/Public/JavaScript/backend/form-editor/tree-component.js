/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import $ from"jquery";import*as Helper from"@typo3/form/backend/form-editor/helper.js";import Icons from"@typo3/backend/icons.js";import Sortable from"sortablejs";var TreeNodeLinkType;!function(e){e.hidden="hidden",e.connect="connect",e.line="line",e.last="last"}(TreeNodeLinkType||(TreeNodeLinkType={}));const defaultConfiguration={domElementClassNames:{collapsed:"collapsed",expanded:"expanded",hasChildren:"has-children",sortable:"sortable",noNesting:"no-nesting"},domElementDataAttributeNames:{abstractType:"data-element-abstract-type"},domElementDataAttributeValues:{collapse:"actions-chevron-right",expander:"treeExpander",title:"treeTitle"},isSortable:!0};let configuration=null,formEditorApp=null,treeDomElement=null;const expanderStates={};function getFormEditorApp(){return formEditorApp}function getHelper(e){return getUtility().isUndefinedOrNull(e)?Helper.setConfiguration(configuration):Helper.setConfiguration(e)}function getUtility(){return getFormEditorApp().getUtility()}function assert(e,t,r){return getFormEditorApp().assert(e,t,r)}function getRootFormElement(){return getFormEditorApp().getRootFormElement()}function getCurrentlySelectedFormElement(){return getFormEditorApp().getCurrentlySelectedFormElement()}function getPublisherSubscriber(){return getFormEditorApp().getPublisherSubscriber()}function getFormElementDefinition(e,t){return getFormEditorApp().getFormElementDefinition(e,t)}function renderTreeNodeLink(e){const t=document.createElement("span");return t.classList.add("formeditor-tree-line","formeditor-tree-line--"+e),t}function renderNestedSortableListItem(e,t,r){assert("object"===$.type(e),'Invalid parameter "formElement"',1478715704);const n=$("<li></li>");getFormElementDefinition(e,"_isCompositeFormElement")||n.addClass(getHelper().getDomElementClassName("noNesting"));const i=$("<div></div>").addClass("formeditor-tree-item").attr(getHelper().getDomElementDataAttribute("elementIdentifier"),e.get("__identifierPath")).append($("<span></span>").addClass("formeditor-tree-title").attr(getHelper().getDomElementDataAttribute("identifier"),getHelper().getDomElementDataAttributeValue("title")).append(buildTitleByFormElement(e)));getFormElementDefinition(e,"_isCompositeFormElement")&&i.attr(getHelper().getDomElementDataAttribute("abstractType"),"isCompositeFormElement"),getFormElementDefinition(e,"_isTopLevelFormElement")&&i.attr(getHelper().getDomElementDataAttribute("abstractType"),"isTopLevelFormElement");const o=document.createElement("span");o.classList.add("caret");const l=$("<span></span>").addClass("formeditor-tree-expander").attr("data-identifier",getHelper().getDomElementDataAttributeValue("expander")).append(o);i.prepend(l),Icons.getIcon(getFormElementDefinition(e,"iconIdentifier"),Icons.sizes.small,null,Icons.states.default).then((function(o){l.after($("<span></span>").addClass("formeditor-tree-icon").addClass(getHelper().getDomElementClassName("icon")).attr("title","id = "+e.get("identifier")).append(o)),getFormElementDefinition(e,"_isCompositeFormElement")?e.get("renderables")&&e.get("renderables").length>0?(l.before(renderTreeNodeLink(t!=r?TreeNodeLinkType.connect:TreeNodeLinkType.last)),n.addClass(getHelper().getDomElementClassName("hasChildren"))):l.before(renderTreeNodeLink(TreeNodeLinkType.connect)).remove():(i.prepend(renderTreeNodeLink(t!=r?TreeNodeLinkType.connect:TreeNodeLinkType.last)),l.remove());let a=e.get("__parentRenderable");for(;a&&a.get("__identifierPath")!==getRootFormElement().get("__identifierPath");)a.get("__identifierPath")===getFormEditorApp().getLastFormElementWithinParentFormElement(a).get("__identifierPath")?i.prepend(renderTreeNodeLink(TreeNodeLinkType.hidden)):i.prepend(renderTreeNodeLink(TreeNodeLinkType.line)),a=a.get("__parentRenderable")})),n.append(i),getPublisherSubscriber().publish("view/tree/render/listItemAdded",[n,e]);const a=e.get("renderables");let d=null;if("array"===$.type(a)){d=$("<ol></ol>");for(let e=0,t=a.length;e<t;++e)d.append(renderNestedSortableListItem(a[e],e+1,t))}return d&&n.append(d),n}function addSortableEvents(){const e={handle:"div"+getHelper().getDomElementDataAttribute("elementIdentifier","bracesWithKey"),draggable:"li",animation:200,fallbackTolerance:200,fallbackOnBody:!0,swapThreshold:.6,dragClass:"formeditor-sortable-drag",ghostClass:"formeditor-sortable-ghost",onChange:function(e){let t;const r=getParentTreeNodeIdentifierPathWithinDomElement($(e.item));r&&(t=getFormEditorApp().findEnclosingCompositeFormElementWhichIsNotOnTopLevel(r)),getPublisherSubscriber().publish("view/tree/dnd/change",[$(e.item),r,t])},onEnd:function(e){const t=getTreeNodeIdentifierPathWithinDomElement($(e.item)),r=getSiblingTreeNodeIdentifierPathWithinDomElement($(e.item),"prev"),n=getSiblingTreeNodeIdentifierPathWithinDomElement($(e.item),"next");getPublisherSubscriber().publish("view/tree/dnd/update",[$(e.item),t,r,n]),getPublisherSubscriber().publish("view/tree/dnd/stop",[getTreeNodeIdentifierPathWithinDomElement($(e.item))])}},t=treeDomElement.get(0).querySelector("ol."+getHelper().getDomElementClassName("sortable"));new Sortable(t,{...e,group:"tree-step-nodes",put:["tree-step-nodes"]}),t.querySelectorAll("ol").forEach((function(t){new Sortable(t,{...e,group:"tree-leaves-nodes",pull:["tree-leaves-nodes"]})}))}function saveExpanderStates(){const e=function(t){if(getFormElementDefinition(t,"_isCompositeFormElement")){const e=getTreeNode(t);e.length&&(e.closest("li").hasClass(getHelper().getDomElementClassName("expanded"))?expanderStates[t.get("__identifierPath")]=!0:expanderStates[t.get("__identifierPath")]=!1),getUtility().isUndefinedOrNull(expanderStates[t.get("__identifierPath")])&&(expanderStates[t.get("__identifierPath")]=!0)}const r=t.get("renderables");if("array"===$.type(r))for(let t=0,n=r.length;t<n;++t)e(r[t])};e(getRootFormElement());for(const e of Object.keys(expanderStates))try{getFormEditorApp().getFormElementByIdentifierPath(e)}catch{delete expanderStates[e]}}function loadExpanderStates(){for(const e of Object.keys(expanderStates)){const t=getTreeNode(e);t.length&&(expanderStates[e]?t.closest("li").removeClass(getHelper().getDomElementClassName("collapsed")).addClass(getHelper().getDomElementClassName("expanded")):t.closest("li").addClass(getHelper().getDomElementClassName("collapsed")).removeClass(getHelper().getDomElementClassName("expanded")))}}export function renderCompositeFormElementChildsAsSortableList(e){assert("object"===$.type(e),'Invalid parameter "formElement"',1478721208);const t=$("<ol></ol>").addClass(getHelper().getDomElementClassName("sortable"));if("array"===$.type(e.get("renderables")))for(let r=0,n=e.get("renderables").length;r<n;++r)t.append(renderNestedSortableListItem(e.get("renderables")[r],r+1,n));return t}export function renew(e){getFormEditorApp().getUtility().isUndefinedOrNull(e)&&(e=getRootFormElement()),saveExpanderStates(),treeDomElement.off().empty().append(renderCompositeFormElementChildsAsSortableList(e));let t=0;treeDomElement.on("click",(function(e){const r=$(e.target).closest(getHelper().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).attr(getHelper().getDomElementDataAttribute("elementIdentifier"));!getUtility().isUndefinedOrNull(r)&&getUtility().isNonEmptyString(r)&&(t++,1===t&&setTimeout((function(){1===t?getPublisherSubscriber().publish("view/tree/node/clicked",[r]):editTreeNodeLabel(r),t=0}),300))})),$(getHelper().getDomElementDataIdentifierSelector("expander"),treeDomElement).on("click",(function(){$(this).closest("li").toggleClass(getHelper().getDomElementClassName("collapsed")).toggleClass(getHelper().getDomElementClassName("expanded"))})),configuration.isSortable&&addSortableEvents(),loadExpanderStates()}export function getAllTreeNodes(){return $(getHelper().getDomElementDataAttribute("elementIdentifier","bracesWithKey"),treeDomElement)}export function getTreeNodeWithinDomElement(e){return $(e).find(getHelper().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).first()}export function getTreeNodeIdentifierPathWithinDomElement(e){return getTreeNodeWithinDomElement($(e)).attr(getHelper().getDomElementDataAttribute("elementIdentifier"))}export function getParentTreeNodeWithinDomElement(e){return $(e).parent().closest("li").find(getHelper().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).first()}export function getParentTreeNodeIdentifierPathWithinDomElement(e){return getParentTreeNodeWithinDomElement(e).attr(getHelper().getDomElementDataAttribute("elementIdentifier"))}export function getSiblingTreeNodeIdentifierPathWithinDomElement(e,t){getUtility().isUndefinedOrNull(t)&&(t="prev");const r=getTreeNodeIdentifierPathWithinDomElement(e);return(e="prev"===t?$(e).prev("li"):$(e).next("li")).find(getHelper().getDomElementDataAttribute("elementIdentifier","bracesWithKey")).not(getHelper().getDomElementDataAttribute("elementIdentifier","bracesWithKeyValue",[r])).first().attr(getHelper().getDomElementDataAttribute("elementIdentifier"))}export function setTreeNodeTitle(e,t){let r;getUtility().isUndefinedOrNull(e)?r=buildTitleByFormElement(t):(r=document.createElement("span"),r.textContent=e),$(getHelper().getDomElementDataIdentifierSelector("title"),getTreeNode(t)).get(0).replaceChildren(r)}export function getTreeNode(e){let t;return t="string"==typeof e?e:getUtility().isUndefinedOrNull(e)?getCurrentlySelectedFormElement().get("__identifierPath"):e.get("__identifierPath"),$(getHelper().getDomElementDataAttribute("elementIdentifier","bracesWithKeyValue",[t]),treeDomElement)}export function buildTitleByFormElement(e){getUtility().isUndefinedOrNull(e)&&(e=getCurrentlySelectedFormElement()),assert("object"===$.type(e),'Invalid parameter "formElement"',1478719287);const t=document.createElement("span");t.textContent=e.get("label")?e.get("label"):e.get("identifier");const r=document.createElement("small");return r.textContent="("+getFormElementDefinition(e,"label")+")",t.appendChild(r),t}export function getTreeDomElement(){return treeDomElement}function editTreeNodeLabel(e){const t=getTreeNode(e),r=$(getHelper().getDomElementDataIdentifierSelector("title"),t).children()[0].childNodes[0].nodeValue.trim();let n=!0;const i=$("<input>").attr("class","formeditor-tree-edit").attr("type","text").attr("value",r).on("click",(e=>{e.stopPropagation()})).on("keyup",(function(t){if(13===t.keyCode||9===t.keyCode){const t=this.value.trim();getUtility().isNonEmptyString(t)&&t!==r?(n=!1,i.remove(),getPublisherSubscriber().publish("view/tree/node/changed",[e,t])):(n=!1,i.remove())}else 27===t.keyCode&&(n=!1,i.remove())})).on("blur",(function(){if(n){const t=this.value.trim();i.remove(),getUtility().isNonEmptyString(t)&&t!==r&&getPublisherSubscriber().publish("view/tree/node/changed",[e,t])}}));t.append(i),i.focus()}export function bootstrap(e,t,r){return formEditorApp=e,assert("object"===$.type(t),'Invalid parameter "appendToDomElement"',1478714814),treeDomElement=$(t),configuration=$.extend(!0,defaultConfiguration,r||{}),Helper.bootstrap(formEditorApp),this}