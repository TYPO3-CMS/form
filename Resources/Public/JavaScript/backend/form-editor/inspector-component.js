/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import n from"jquery";import*as A from"@typo3/form/backend/form-editor/helper.js";import S from"@typo3/backend/icons.js";import j from"@typo3/backend/modal.js";import{MessageUtility as ce}from"@typo3/backend/utility/message-utility.js";import me from"sortablejs";import{selector as de}from"@typo3/core/literals.js";import{PropertyGridEditorUpdateEvent as ue}from"@typo3/form/backend/form-editor/component/property-grid-editor.js";import"@typo3/rte-ckeditor/ckeditor5.js";import{FormElementSelectorSelectedEvent as Ee}from"@typo3/form/backend/form-editor/component/form-element-selector.js";const ye={domElementClassNames:{buttonFormElementRemove:"formeditor-inspector-element-remove-button",collectionElement:"formeditor-inspector-collection-element",finisherEditorPrefix:"t3-form-inspector-finishers-editor-",inspectorEditor:"formeditor-inspector-element",inspectorInputGroup:"input-group",validatorEditorPrefix:"formeditor-inspector-validators-editor-"},domElementDataAttributeNames:{contentElementSelectorTarget:"data-insert-target",finisher:"data-finisher-identifier",validator:"data-validator-identifier",randomId:"data-random-id",randomIdTarget:"data-random-id-attribute",randomIdIndex:"data-random-id-number",maximumFileSize:"data-maximumFileSize"},domElementDataAttributeValues:{collapse:"actions-view-table-expand",editorControlsInputGroup:"inspectorEditorControlsGroup",editorWrapper:"editorWrapper",editorControlsWrapper:"inspectorEditorControlsWrapper",formElementHeaderEditor:"inspectorFormElementHeaderEditor",formElementSelectorControlsWrapper:"inspectorEditorFormElementSelectorControlsWrapper",formElementSelectorSplitButtonContainer:"inspectorEditorFormElementSelectorSplitButtonContainer",formElementSelectorSplitButtonListContainer:"inspectorEditorFormElementSelectorSplitButtonListContainer",iconNotAvailable:"actions-close",inspector:"inspector","Inspector-CheckboxEditor":"Inspector-CheckboxEditor","Inspector-CollectionElementHeaderEditor":"Inspector-CollectionElementHeaderEditor","Inspector-FinishersEditor":"Inspector-FinishersEditor","Inspector-FormElementHeaderEditor":"Inspector-FormElementHeaderEditor","Inspector-PropertyGridEditor":"Inspector-PropertyGridEditor","Inspector-RemoveElementEditor":"Inspector-RemoveElementEditor","Inspector-RequiredValidatorEditor":"Inspector-RequiredValidatorEditor","Inspector-SingleSelectEditor":"Inspector-SingleSelectEditor","Inspector-MultiSelectEditor":"Inspector-MultiSelectEditor","Inspector-GridColumnViewPortConfigurationEditor":"Inspector-GridColumnViewPortConfigurationEditor","Inspector-TextareaEditor":"Inspector-TextareaEditor","Inspector-TextEditor":"Inspector-TextEditor","Inspector-Typo3WinBrowserEditor":"Inspector-Typo3WinBrowserEditor","Inspector-ValidatorsEditor":"Inspector-ValidatorsEditor","Inspector-ValidationErrorMessageEditor":"Inspector-ValidationErrorMessageEditor",inspectorFinishers:"inspectorFinishers",inspectorValidators:"inspectorValidators",viewportButton:"viewportButton"},domElementIdNames:{finisherPrefix:"t3-form-inspector-finishers-",validatorPrefix:"t3-form-inspector-validators-"},isSortable:!0};let U=null,L=null;function f(){return L}function O(){return f().getViewModel()}function l(e){return m().isUndefinedOrNull(e)?A.setConfiguration(U):A.setConfiguration(e)}function m(){return f().getUtility()}function i(e,t,r){return f().assert(e,t,r)}function be(){return f().getRootFormElement()}function y(){return f().getCurrentlySelectedFormElement()}function N(){return f().getPublisherSubscriber()}function w(e,t){return f().getFormElementDefinition(e,t)}function z(e,t,r,a){switch(e.templateName){case"Inspector-FormElementHeaderEditor":$(e,t);break;case"Inspector-CollectionElementHeaderEditor":J(e,t,r,a);break;case"Inspector-MaximumFileSizeEditor":Y(e,t);break;case"Inspector-TextEditor":Q(e,t,r,a);break;case"Inspector-FinishersEditor":G("finishers",e,t);break;case"Inspector-ValidatorsEditor":G("validators",e,t);break;case"Inspector-ValidationErrorMessageEditor":X(e,t);break;case"Inspector-RemoveElementEditor":oe(e,t,r,a);break;case"Inspector-RequiredValidatorEditor":ne(e,t,r,a);break;case"Inspector-CheckboxEditor":re(e,t,r,a);break;case"Inspector-CountrySelectEditor":Z(e,t,r,a);break;case"Inspector-SingleSelectEditor":C(e,t,r,a);break;case"Inspector-MultiSelectEditor":H(e,t,r,a);break;case"Inspector-GridColumnViewPortConfigurationEditor":ee(e,t);break;case"Inspector-PropertyGridEditor":te(e,t,r,a);break;case"Inspector-TextareaEditor":ae(e,t,r,a);break;case"Inspector-Typo3WinBrowserEditor":le(e,t,r,a);break;default:break}N().publish("view/inspector/editor/insert/perform",[e,t,r,a])}function fe(e,t,r){const a=new URLSearchParams({mode:e,fieldReference:t,allowedTypes:r});j.advanced({type:j.types.iframe,content:TYPO3.settings.FormEditor.typo3WinBrowserUrl+"&"+a.toString(),size:j.sizes.large})}function ve(){window.addEventListener("message",function(e){if(!ce.verifyOrigin(e.origin))throw"Denied message sent by "+e.origin;if(e.data.actionName==="typo3:elementBrowser:elementAdded"){if(typeof e.data.fieldName>"u")throw"fieldName not defined in message";if(typeof e.data.value>"u")throw"value not defined in message";const t=e.data.value.split("_");n(l().getDomElementDataAttribute("contentElementSelectorTarget","bracesWithKeyValue",[e.data.fieldName])).val(t.pop()).trigger("paste")}})}function he(e,t){return e==="finishers"?l().getDomElementClassName("finisherEditorPrefix")+t:l().getDomElementClassName("validatorEditorPrefix")+t}function R(e,t,r){return e==="finishers"?l().getDomElementIdName("finisherPrefix",r)+t:l().getDomElementIdName("validatorPrefix",r)+t}function ge(e,t){e.addClass(l().getDomElementClassName("sortable")),new me(e.get(0),{draggable:l().getDomElementClassName("collectionElement",!0),filter:"input,textarea,select",preventOnFilter:!1,animation:200,fallbackTolerance:200,swapThreshold:.6,dragClass:"formeditor-sortable-drag",ghostClass:"formeditor-sortable-ghost",onEnd:function(r){let a;t==="finishers"?a=l().getDomElementDataAttribute("finisher"):a=l().getDomElementDataAttribute("validator");const o=n(r.item).attr(a),s=n(r.item).prevAll(l().getDomElementClassName("collectionElement",!0)).first().attr(a),d=n(r.item).nextAll(l().getDomElementClassName("collectionElement",!0)).first().attr(a);N().publish("view/inspector/collectionElements/dnd/update",[o,s,d,t])}})}function B(e){return n(l().getDomElementDataIdentifierSelector("editorWrapper"),n(e))}function x(e){return n(l().getDomElementDataIdentifierSelector("editorControlsWrapper"),n(e))}function P(e,t){let r,a,o;o=f().validateCurrentlySelectedFormElementProperty(e),o.length>0?(l().getTemplatePropertyDomElement("validationErrors",t).html('<span class="text-danger">'+o[0]+"</span>"),O().setElementValidationErrorClass(x(t),"hasError")):(l().getTemplatePropertyDomElement("validationErrors",t).html(""),O().removeElementValidationErrorClass(x(t),"hasError")),o=f().validateFormElement(y()),a=e.split("."),a=a[0]+"."+a[1],r=!1;for(let s=0,d=o.length;s<d;++s)if(o[s].propertyPath.indexOf(a,0)===0&&o[s].validationResults&&o[s].validationResults.length>0){r=!0;break}r?O().setElementValidationErrorClass(x(t).closest(l().getDomElementClassName("collectionElement",!0))):O().removeElementValidationErrorClass(x(t).closest(l().getDomElementClassName("collectionElement",!0)))}function _(e,t){i(n.type(e)==="array",'Invalid configuration "errorCodes"',1489932939),i(n.type(t)==="array",'Invalid configuration "propertyData"',1489932940);for(let r=0,a=e.length;r<a;++r)for(let o=0,s=t.length;o<s;++o)if(parseInt(e[r],10)===parseInt(t[o].code,10)&&m().isNonEmptyString(t[o].message))return t[o].message;return null}function W(e,t,r){if(i(n.type(t)==="array",'Invalid configuration "propertyData"',1489932942),!m().isUndefinedOrNull(e)&&n.type(e)==="array"){const a=[];for(let o=0,s=e.length;o<s;++o){let d=!1;for(let p=0,c=t.length;p<c;++p)parseInt(e[o],10)===parseInt(t[p].code,10)&&(d=!0,m().isNonEmptyString(r)?t[p].message=r:(t.splice(p,1),--c));d||m().isNonEmptyString(r)&&a.push({code:e[o],message:r})}t=t.concat(a)}return t}function K(e){i(n.type(e)==="object",'Invalid input "html"',1523904699),n(l().getDomElementClassName("inspectorEditor",!0)).each(function(){const t=n(this),r={};n(l().getDomElementDataAttribute("randomId","bracesWithKey"),t).each(function(){const a=n(this),o=a.attr(l().getDomElementDataAttribute("randomIdTarget")),s=a.attr(l().getDomElementDataAttribute("randomIdIndex"));a.is("["+o+"]")||(s in r||(r[s]="fe"+Math.floor(Math.random()*42)+Date.now()),a.attr(o,r[s]))})})}function F(){return n(l().getDomElementDataIdentifierSelector("inspector"))}function k(){return n(l().getDomElementDataIdentifierSelector("inspectorFinishers"),F())}function V(){return n(l().getDomElementDataIdentifierSelector("inspectorValidators"),F())}function M(e,t){return e==="finishers"?n(l().getDomElementDataAttribute("finisher","bracesWithKeyValue",[t]),k()):n(l().getDomElementDataAttribute("validator","bracesWithKeyValue",[t]),V())}function Pe(e,t){m().isUndefinedOrNull(e)&&(e=y()),F().off().empty();const r=w(e,void 0);if(n.type(r.editors)==="array"){for(let a=0,o=r.editors.length;a<o;++a){const s=l().getTemplate(r.editors[a].templateName).clone();if(!s.length)continue;const d=n(s.html());n(d).first().addClass(l().getDomElementClassName("inspectorEditor")),F().append(n(d)),K(d),z(r.editors[a],d)}n.type(t)==="function"&&t()}}function Ie(e,t){let r,a,o;i(m().isNonEmptyString(e),'Invalid parameter "collectionName"',1478354853),i(m().isNonEmptyString(t),'Invalid parameter "collectionElementIdentifier"',1478354854);const s=f().getPropertyCollectionElementConfiguration(t,e);if(n.type(s.editors)!=="array")return;const d=n("<div></div>").addClass(l().getDomElementClassName("collectionElement")).addClass("panel").addClass("panel-default");e==="finishers"?(o=k(),d.attr(l().getDomElementDataAttribute("finisher"),t)):(o=V(),d.attr(l().getDomElementDataAttribute("validator"),t)),o.append(d);const p=s.editors.length;p>0&&s.editors[0].identifier==="header"&&(a=document.createElement("div"),a.classList.add("panel-body"),r=document.createElement("div"),r.classList.add("panel-collapse","collapse"),r.id=R(e,t),r.appendChild(a));for(let c=0;c<p;++c){const b=l().getTemplate(s.editors[c].templateName).clone();if(!b.length)continue;const E=n(b.html());n(E).first().addClass(he(e,s.editors[c].identifier)).addClass(l().getDomElementClassName("inspectorEditor")),c===0&&r?M(e,t).append(E).append(r):c===p-1&&r&&s.editors[c].identifier==="removeButton"||c>0&&r?a.append(E.get(0)):M(e,t).append(E),K(E),z(s.editors[c],E,t,e)}(p===2&&s.editors[0].identifier==="header"&&s.editors[1].identifier==="removeButton"||p===1&&s.editors[0].identifier==="header")&&n(l().getDomElementDataIdentifierSelector("collapse"),d).remove(),U.isSortable&&ge(o,e)}function G(e,t,r){let a,o,s;i(m().isNonEmptyString(e),'Invalid configuration "collectionName"',1478362968),i(n.type(t)==="object",'Invalid parameter "editorConfiguration"',1475423098),i(n.type(r)==="object",'Invalid parameter "editorHtml"',1475423099),i(m().isNonEmptyString(t.label),'Invalid configuration "label"',1475423100),i(n.type(t.selectOptions)==="array",'Invalid configuration "selectOptions"',1475423101),e==="finishers"?(o=k(),a=be().get(e)):(o=V(),a=y().get(e)),o.off().empty(),l().getTemplatePropertyDomElement("label",r).text(t.label);const d=l().getTemplatePropertyDomElement("selectOptions",r),p=!m().isUndefinedOrNull(a)&&a.length>0;if(p)for(let c=0,b=a.length;c<b;++c)N().publish("view/inspector/collectionElement/existing/selected",[a[c].identifier,e]);s=!0;for(let c=0,b=t.selectOptions.length;c<b;++c){let E=!0;if(!m().isUndefinedOrNull(a)){for(let u=0,v=a.length;u<v;++u)if(a[u].identifier===t.selectOptions[c].value){E=!1;break}}E&&(d.append(new Option(t.selectOptions[c].label,t.selectOptions[c].value)),t.selectOptions[c].value!==""&&(s=!1))}if(s){l().getTemplatePropertyDomElement("select-group",r).off().empty().remove();const c=l().getTemplatePropertyDomElement("label-no-select",r);p?c.text(t.label):c.remove();return}l().getTemplatePropertyDomElement("label-no-select",r).remove(),d.on("change",function(){if(n(this).val()!==""){const c=n(this).val();n(de`option[value="${c}"]`,n(this)).remove(),f().getPublisherSubscriber().publish("view/inspector/collectionElement/new/selected",[c,e])}})}function $(e,t){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475421525),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1475421526),S.getIcon(w(y(),"iconIdentifier"),S.sizes.small,null,S.states.default).then(function(r){l().getTemplatePropertyDomElement("header-label",t).append(n(r).addClass(l().getDomElementClassName("icon"))).append(ie()).append("<code>"+y().get("identifier")+"</code>")})}function J(e,t,r,a){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475421258),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1475421257),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1475421259);const o=function(d){const p=l().getTemplatePropertyDomElement("panel-icon",t);d?p.replaceWith(d):p.remove();const c=f().getPropertyCollectionElementConfiguration(r,a).editors;if(!(c.length===2&&c[0].identifier==="header"&&c[1].identifier==="removeButton"||c.length===1&&c[0].identifier==="header")){const u=document.createElement("button");u.classList.add("panel-button","collapsed"),u.setAttribute("type","button"),u.setAttribute("data-bs-toggle","collapse"),u.setAttribute("data-bs-target",R(a,r,!0)),u.setAttribute("aria-expaned","false"),u.setAttribute("aria-controls",R(a,r));const v=document.createElement("span");v.classList.add("caret"),l().getTemplatePropertyDomElement("panel-heading-row",t).find(".panel-title").before(v),l().getTemplatePropertyDomElement("panel-heading-row",t).wrapInner(u)}const E=M(a,r).get(0).querySelector(".formeditor-inspector-element-remove-button");if(E){const u=E.querySelector("button");u.classList.add("btn-sm"),u.querySelector(".btn-label").classList.add("visually-hidden");const v=document.createElement("div");v.classList.add("panel-actions"),v.append(u),l().getTemplatePropertyDomElement("panel-heading-row",t).append(v)}E?.remove()},s=f().getFormEditorDefinition(a,r);"iconIdentifier"in s?S.getIcon(s.iconIdentifier,S.sizes.small,null,S.states.default).then(function(d){o(d)}):o(),e.label&&l().getTemplatePropertyDomElement("panel-title",t).removeAttr("data-template-property").append(e.label)}function Y(e,t){if(i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475421258),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1475421257),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1475421259),e.label){const r=l().getTemplatePropertyDomElement("label",t),a=r.attr(l().getDomElementDataAttribute("maximumFileSize"));r.append(e.label.replace("{0}",a))}}function Q(e,t,r,a){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475421053),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1475421054),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1475421055),i(m().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1475421056),l().getTemplatePropertyDomElement("label",t).append(e.label),D(e,t),m().isNonEmptyString(e.placeholder)&&l().getTemplatePropertyDomElement("propertyPath",t).attr("placeholder",e.placeholder);const o=f().buildPropertyPath(e.propertyPath,r,a),s=y().get(o);if(P(o,t),l().getTemplatePropertyDomElement("propertyPath",t).val(s),!m().isUndefinedOrNull(e.additionalElementPropertyPaths)&&n.type(e.additionalElementPropertyPaths)==="array")for(let d=0,p=e.additionalElementPropertyPaths.length;d<p;++d)y().set(e.additionalElementPropertyPaths[d],s);se(e,t,o),l().getTemplatePropertyDomElement("propertyPath",t).on("keyup paste",function(){if(e.doNotSetIfPropertyValueIsEmpty&&!m().isNonEmptyString(n(this).val())?y().unset(o):y().set(o,n(this).val()),P(o,t),!m().isUndefinedOrNull(e.additionalElementPropertyPaths)&&n.type(e.additionalElementPropertyPaths)==="array")for(let d=0,p=e.additionalElementPropertyPaths.length;d<p;++d)e.doNotSetIfPropertyValueIsEmpty&&!m().isNonEmptyString(n(this).val())?y().unset(e.additionalElementPropertyPaths[d]):y().set(e.additionalElementPropertyPaths[d],n(this).val())})}function X(e,t){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1489874121),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1489874122),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1489874123),i(m().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1489874124),l().getTemplatePropertyDomElement("label",t).append(e.label),D(e,t);const r=f().buildPropertyPath(e.propertyPath);let a=y().get(r);if(!m().isUndefinedOrNull(a)&&n.type(a)==="array"){const o=_(e.errorCodes,a);m().isUndefinedOrNull(o)||l().getTemplatePropertyDomElement("propertyPath",t).val(o)}l().getTemplatePropertyDomElement("propertyPath",t).on("keyup paste",function(){a=y().get(r),m().isUndefinedOrNull(a)&&(a=[]),y().set(r,W(e.errorCodes,a,n(this).val()))})}function Z(e,t,r,a){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1674826430),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1674826431),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1674826432);const o=f().buildPropertyPath(e.propertyPath,r,a);l().getTemplatePropertyDomElement("label",t).append(e.label),D(e,t);const s=l().getTemplatePropertyDomElement("selectOptions",t),d=y().get(o)||{};P(o,t);const p=n("option",s);s.empty();for(let c=0,b=p.length;c<b;++c){let E=!1;for(const v of Object.keys(d))if(p[c].value===d[v]){E=!0;break}const u=new Option(p[c].text,c.toString(),!1,E);n(u).data({value:p[c].value}),s.append(u)}s.on("change",function(){const c=[];n("option:selected",n(this)).each(function(){c.push(n(this).data("value"))}),y().set(o,c),P(o,t)})}function C(e,t,r,a){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475421048),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1475421049),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1475421050),i(m().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1475421051),i(n.type(e.selectOptions)==="array",'Invalid configuration "selectOptions"',1475421052);const o=f().buildPropertyPath(e.propertyPath,r,a);l().getTemplatePropertyDomElement("label",t).append(e.label),D(e,t);const s=l().getTemplatePropertyDomElement("selectOptions",t),d=y().get(o);P(o,t);for(let p=0,c=e.selectOptions.length;p<c;++p){let b;e.selectOptions[p].value===d?b=new Option(e.selectOptions[p].label,p.toString(),!1,!0):b=new Option(e.selectOptions[p].label,p.toString()),n(b).data({value:e.selectOptions[p].value}),s.append(b)}s.on("change",function(){y().set(o,n("option:selected",n(this)).data("value")),P(o,t)})}function H(e,t,r,a){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1485712399),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1485712400),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1485712401),i(m().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1485712402),i(n.type(e.selectOptions)==="array",'Invalid configuration "selectOptions"',1485712403);const o=f().buildPropertyPath(e.propertyPath,r,a);l().getTemplatePropertyDomElement("label",t).append(e.label),D(e,t);const s=l().getTemplatePropertyDomElement("selectOptions",t),d=y().get(o)||{};P(o,t);for(let p=0,c=e.selectOptions.length;p<c;++p){let b=null;for(const E of Object.keys(d))if(e.selectOptions[p].value===d[E]){b=new Option(e.selectOptions[p].label,p.toString(),!1,!0);break}b||(b=new Option(e.selectOptions[p].label,p.toString())),n(b).data({value:e.selectOptions[p].value}),s.append(b)}s.on("change",function(){const p=[];n("option:selected",n(this)).each(function(){p.push(n(this).data("value"))}),y().set(o,p),P(o,t)})}function ee(e,t){if(i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1489528242),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1489528243),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1489528244),i(n.type(e.configurationOptions.viewPorts)==="array",'Invalid configurationOptions "viewPorts"',1489528245),i(!m().isUndefinedOrNull(e.configurationOptions.numbersOfColumnsToUse.label),'Invalid configurationOptions "numbersOfColumnsToUse"',1489528246),i(!m().isUndefinedOrNull(e.configurationOptions.numbersOfColumnsToUse.propertyPath),'Invalid configuration "selectOptions"',1489528247),!w(y().get("__parentRenderable"),"_isGridRowFormElement")){t.remove();return}l().getTemplatePropertyDomElement("label",t).append(e.label);const r=n(l().getDomElementDataIdentifierSelector("viewportButton"),n(t)).clone();n(l().getDomElementDataIdentifierSelector("viewportButton"),n(t)).remove();const a=l().getTemplatePropertyDomElement("numbersOfColumnsToUse",n(t)).clone();l().getTemplatePropertyDomElement("numbersOfColumnsToUse",n(t)).remove();const o=x(t),s=function(d){l().getTemplatePropertyDomElement("numbersOfColumnsToUse",n(t)).off().empty().remove();const p=n(a).clone(!0,!0);B(t).after(p),n("input",p).focus(),l().getTemplatePropertyDomElement("numbersOfColumnsToUse-label",p).append(e.configurationOptions.numbersOfColumnsToUse.label.replace("{@viewPortLabel}",d.data("viewPortLabel"))),l().getTemplatePropertyDomElement("numbersOfColumnsToUse-description",p).append(e.configurationOptions.numbersOfColumnsToUse.description);const c=e.configurationOptions.numbersOfColumnsToUse.propertyPath.replace("{@viewPortIdentifier}",d.data("viewPortIdentifier"));l().getTemplatePropertyDomElement("numbersOfColumnsToUse-propertyPath",p).val(y().get(c)),l().getTemplatePropertyDomElement("numbersOfColumnsToUse-propertyPath",p).on("keyup paste change",function(){const b=n(this);n.isNumeric(b.val())||b.val(""),y().set(c,b.val())})};for(let d=0,p=e.configurationOptions.viewPorts.length;d<p;++d){const c=e.configurationOptions.viewPorts[d].viewPortIdentifier,b=e.configurationOptions.viewPorts[d].label,E=n(r).clone(!0,!0);if(E.text(c),E.data("viewPortIdentifier",c),E.data("viewPortLabel",b),E.attr("title",b),o.append(E),d===p-1){const u=n(a).clone(!0,!0);B(t).after(u),s(E),E.addClass(l().getDomElementClassName("active"))}n("button",o).on("click",function(){const u=n(this);n("button",o).removeClass(l().getDomElementClassName("active")),u.addClass(l().getDomElementClassName("active")),s(u)})}}function te(e,t,r,a){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475419226),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1475419227),i(n.type(e.enableAddRow)==="boolean",'Invalid configuration "enableAddRow"',1475419228),i(n.type(e.enableDeleteRow)==="boolean",'Invalid configuration "enableDeleteRow"',1475419230),i(n.type(e.isSortable)==="boolean",'Invalid configuration "isSortable"',1475419229),i(m().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1475419231),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1475419232),l().getTemplatePropertyDomElement("label",t).append(e.label),D(e,t);const o=(()=>{const u=f().buildPropertyPath(void 0,r,a,void 0,!0);return m().isNonEmptyString(u)?u+".":u})(),s=m().isUndefinedOrNull(e.multiSelection)?!1:!!e.multiSelection,d=m().isNonEmptyArray(e.gridColumns)?e.gridColumns.some(u=>u.name==="selected"):!0,p=(()=>{const u=y().get(o+"defaultValue");return m().isUndefinedOrNull(u)?{}:s?u:{0:u}})(),c=(()=>{const u=y(),v=o+e.propertyPath,g=u.get(v)||{};let I;return Array.isArray(g)?I=g.map((h,T)=>({id:"fe"+Math.floor(Math.random()*42)+Date.now(),label:m().isUndefinedOrNull(h._label)?h:h._label,value:m().isUndefinedOrNull(h._label)?T:h._value,selected:!1})):typeof g=="object"&&(I=Object.entries(g).map(([h,T])=>({id:"fe"+Math.floor(Math.random()*42)+Date.now(),label:T,value:h,selected:!1}))),I.map(h=>{for(const T of Object.keys(p))if(p[T]===h.value){h.selected=!0;break}return h})})(),b=m().isUndefinedOrNull(e.useLabelAsFallbackValue)?!0:e.useLabelAsFallbackValue,E=t instanceof HTMLElement?t.querySelector("typo3-form-property-grid-editor"):t.get(0).querySelector("typo3-form-property-grid-editor");E.enableAddRow=e.enableAddRow,E.enableSelection=d,E.enableMultiSelection=s,E.enableSorting=e.isSortable??!1,E.enableDeleteRow=e.enableDeleteRow??!1,E.enableLabelAsFallbackValue=b,E.entries=c,m().isNonEmptyArray(e.gridColumns)&&e.gridColumns.forEach(u=>{u.name==="label"&&(E.labelLabel=u.title,E.enableLabelFormElementSelectionButton=u.enableFormelementSelectionButton),u.name==="value"&&(E.labelValue=u.title,E.enableValueFormElementSelectionButton=u.enableFormelementSelectionButton),u.name==="selected"&&(E.labelSelected=u.title)}),(E.enableLabelFormElementSelectionButton||E.enableValueFormElementSelectionButton)&&(E.formElements=pe()),E.addEventListener(ue.eventName,u=>{const v=u.data,g=[],I=[];for(const h of v){const T=h.label,q=h.value===""?h.label:m().canBeInterpretedAsInteger(h.value)?parseInt(h.value,10):h.value;h.selected&&g.push(q),I.push({_label:T,_value:q})}s?y().set(o+"defaultValue",g):y().set(o+"defaultValue",g[0]??"",!0),y().set(o+e.propertyPath,I),P(o+e.propertyPath,t)}),P(o+e.propertyPath,t)}function ne(e,t,r,a){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475417093),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1475417094),i(m().isNonEmptyString(e.validatorIdentifier),'Invalid configuration "validatorIdentifier"',1475417095),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1475417096);const o=e.validatorIdentifier;l().getTemplatePropertyDomElement("label",t).append(e.label);let s,d,p;m().isNonEmptyString(e.propertyPath)&&(d=f().buildPropertyPath(e.propertyPath,r,a)),m().isNonEmptyString(e.propertyValue)?s=e.propertyValue:s="";const c=f().buildPropertyPath(e.configurationOptions.validationErrorMessage.propertyPath),b=l().getTemplatePropertyDomElement("validationErrorMessage",n(t)).clone();l().getTemplatePropertyDomElement("validationErrorMessage",n(t)).remove();const E=function(){const u=n(b).clone(!0,!0);B(t).after(u),l().getTemplatePropertyDomElement("validationErrorMessage-label",u).append(e.configurationOptions.validationErrorMessage.label),l().getTemplatePropertyDomElement("validationErrorMessage-description",u).append(e.configurationOptions.validationErrorMessage.description),p=y().get(c),m().isUndefinedOrNull(p)&&(p=[]);const v=_(e.configurationOptions.validationErrorMessage.errorCodes,p);m().isUndefinedOrNull(v)||l().getTemplatePropertyDomElement("validationErrorMessage-propertyPath",u).val(v),l().getTemplatePropertyDomElement("validationErrorMessage-propertyPath",u).on("keyup paste",function(){let g=y().get(c);m().isUndefinedOrNull(g)&&(g=[]),y().set(c,W(e.configurationOptions.validationErrorMessage.errorCodes,g,n(this).val()))})};f().getIndexFromPropertyCollectionElement(o,"validators")!==-1&&(n('input[type="checkbox"]',n(t)).prop("checked",!0),E()),n('input[type="checkbox"]',n(t)).on("change",function(){l().getTemplatePropertyDomElement("validationErrorMessage",n(t)).off().empty().remove(),n(this).is(":checked")?(E(),N().publish("view/inspector/collectionElement/new/selected",[o,"validators"]),m().isNonEmptyString(d)&&y().set(d,s)):(N().publish("view/inspector/removeCollectionElement/perform",[o,"validators"]),m().isNonEmptyString(d)&&y().unset(d),p=y().get(c),m().isUndefinedOrNull(p)&&(p=[]),y().set(c,W(e.configurationOptions.validationErrorMessage.errorCodes,p,"")))})}function re(e,t,r,a){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1476218671),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1476218672),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1476218673),i(m().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1476218674),l().getTemplatePropertyDomElement("label",t).append(e.label),D(e,t);const o=f().buildPropertyPath(e.propertyPath,r,a),s=y().get(o);(e.propertyPath==="renderingOptions.enabled"&&m().isUndefinedOrNull(s)||n.type(s)==="boolean"&&s||s==="true"||s===1||s==="1")&&n('input[type="checkbox"]',n(t)).prop("checked",!0),n('input[type="checkbox"]',n(t)).on("change",function(){n(this).is(":checked")?y().set(o,!0):y().set(o,!1)})}function ae(e,t,r,a){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475412567),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1475412568),i(m().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1475416098),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1475416099);const o=f().buildPropertyPath(e.propertyPath,r,a);l().getTemplatePropertyDomElement("label",t).append(e.label),D(e,t);const s=y().get(o),p=(t instanceof HTMLElement?t:t[0]).querySelector("textarea");if(!p)throw new Error("Textarea element not found in editor HTML");p.value=s;const c=e.rteOptions||{};if(e.enableRichtext===!0&&c&&typeof c=="object"&&Object.keys(c).length!==0){const u=p.parentElement;if(!u)throw new Error("Textarea wrapper element not found");const v=p.id,g=v?v+"ckeditor5":"",I=document.createElement("typo3-rte-ckeditor-ckeditor5");g&&(I.id=g);const h=JSON.stringify(c);I.setAttribute("options",h),p.setAttribute("slot","textarea"),I.appendChild(p),u.innerHTML="",u.appendChild(I),I.options=c}P(o,t);const b=e.enableRichtext===!0?["change"]:["keyup","paste"],E=u=>{const v=u.target;y().set(o,v.value),P(o,t)};b.forEach(u=>{p.addEventListener(u,E)})}function le(e,t,r,a){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1477300587),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1477300588),i(m().isNonEmptyString(e.label),'Invalid configuration "label"',1477300589),i(m().isNonEmptyString(e.buttonLabel),'Invalid configuration "buttonLabel"',1477318981),i(m().isNonEmptyString(e.propertyPath),'Invalid configuration "propertyPath"',1477300590),l().getTemplatePropertyDomElement("label",t).append(e.label),l().getTemplatePropertyDomElement("buttonLabel",t).append(e.buttonLabel),D(e,t),n("form",n(t)).prop("name",e.propertyPath),S.getIcon(e.iconIdentifier,S.sizes.small).then(function(d){l().getTemplatePropertyDomElement("image",t).append(n(d))}),l().getTemplatePropertyDomElement("onclick",t).on("click",function(){const d=Math.floor(Math.random()*1e5+1);n(this).closest(l().getDomElementDataIdentifierSelector("editorControlsWrapper")).find(l().getDomElementDataAttribute("contentElementSelectorTarget","bracesWithKey")).attr(l().getDomElementDataAttribute("contentElementSelectorTarget"),d),fe("db",String(d),e.browsableType)}),ve();const o=f().buildPropertyPath(e.propertyPath,r,a),s=y().get(o);P(o,t),l().getTemplatePropertyDomElement("propertyPath",t).val(s),l().getTemplatePropertyDomElement("propertyPath",t).on("keyup paste",function(){y().set(o,n(this).val()),P(o,t)})}function oe(e,t,r,a){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1475412563),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1475412564),m().isUndefinedOrNull(r)?n("button",n(t)).addClass(l().getDomElementClassName("buttonFormElementRemove")+" "+l().getDomElementClassName("buttonFormEditor")):n("button",n(t)).addClass(l().getDomElementClassName("buttonCollectionElementRemove")),n("button",n(t)).on("click",function(){m().isUndefinedOrNull(r)?O().showRemoveFormElementModal():O().showRemoveCollectionElementModal(r,a)})}function se(e,t,r){i(n.type(e)==="object",'Invalid parameter "editorConfiguration"',1484574704),i(n.type(t)==="object",'Invalid parameter "editorHtml"',1484574705),i(m().isNonEmptyString(r),'Invalid parameter "propertyPath"',1484574706);const a=t instanceof HTMLElement?t.querySelector("typo3-form-element-selector"):t.get(0).querySelector("typo3-form-element-selector");a&&(e.enableFormelementSelectionButton===!0?(a.elements=pe(),a.addEventListener(Ee.eventName,o=>{let s;s=y().get(r)||"",s.length===0?s=`{${o.value}}`:s=`${s} {${o.value}}`,y().set(r,s),l().getTemplatePropertyDomElement("propertyPath",t).val(s),P(r,t)})):a.remove())}function pe(){return f().getNonCompositeNonToplevelFormElements().map(t=>({icon:w(t,"iconIdentifier"),label:t.get("label"),value:t.get("identifier")}))}function ie(e){m().isUndefinedOrNull(e)&&(e=y()),i(n.type(e)==="object",'Invalid parameter "formElement"',1478967319);let t;e.get("type")==="Form"?t=e.get("type"):t=w(e,"label")?w(e,"label"):e.get("identifier");const r=document.createElement("span");return r.textContent=t,r}function D(e,t){m().isNonEmptyString(e.description)?l().getTemplatePropertyDomElement("description",t).text(e.description):l().getTemplatePropertyDomElement("description",t).remove()}function De(e,t){return L=e,U=n.extend(!0,ye,t||{}),A.bootstrap(L),this}export{De as bootstrap,ie as buildTitleByFormElement,M as getCollectionElementDomElement,k as getFinishersContainerDomElement,F as getInspectorDomElement,V as getValidatorsContainerDomElement,re as renderCheckboxEditor,Ie as renderCollectionElementEditors,J as renderCollectionElementHeaderEditor,G as renderCollectionElementSelectionEditor,Z as renderCountrySelectEditor,D as renderDescription,Pe as renderEditors,Y as renderFileMaxSizeEditor,$ as renderFormElementHeaderEditor,se as renderFormElementSelectorEditorAddition,ee as renderGridColumnViewPortConfigurationEditor,H as renderMultiSelectEditor,te as renderPropertyGridEditor,oe as renderRemoveElementEditor,ne as renderRequiredValidatorEditor,C as renderSingleSelectEditor,Q as renderTextEditor,ae as renderTextareaEditor,le as renderTypo3WinBrowserEditor,X as renderValidationErrorMessageEditor};
