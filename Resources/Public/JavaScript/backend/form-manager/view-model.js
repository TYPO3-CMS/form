/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import e from"jquery";import F from"@typo3/backend/modal.js";import b from"@typo3/backend/severity.js";import t from"@typo3/backend/multi-step-wizard.js";import c from"@typo3/backend/icons.js";import T from"@typo3/backend/notification.js";import y from"@typo3/core/security-utility.js";import{selector as S}from"@typo3/core/literals.js";import Y from"@typo3/backend/sortable-table.js";const v=new y;var n;(function(r){r.newFormModalTrigger='[data-identifier="newForm"]',r.duplicateFormModalTrigger='[data-identifier="duplicateForm"]',r.removeFormModalTrigger='[data-identifier="removeForm"]',r.newFormModeButton='[data-identifier="newFormModeButton"]',r.newFormName='[data-identifier="newFormName"]',r.newFormSavePath='[data-identifier="newFormSavePath"]',r.newFormPrototypeName='[data-identifier="newFormPrototypeName"]',r.newFormTemplate='[data-identifier="newFormTemplate"]',r.duplicateFormName='[data-identifier="duplicateFormName"]',r.duplicateFormSavePath='[data-identifier="duplicateFormSavePath"]',r.showReferences='[data-identifier="showReferences"]',r.referenceLink='[data-identifier="referenceLink"]',r.moduleBody=".module-body.t3js-module-body",r.t3Logo=".t3-message-page-logo",r.t3Footer="#t3-footer",r.formsTable="#forms"})(n||(n={}));function k(r){e(n.newFormModalTrigger).on("click",function(h){h.preventDefault(),t.addSlide("new-form-step-1",TYPO3.lang["formManager.newFormWizard.step1.title"],"",b.notice,TYPO3.lang["formManager.newFormWizard.step1.progressLabel"],async function(m){const o=await c.getIcon("actions-plus",c.sizes.small),l=await c.getIcon("form-page",c.sizes.large),i=await c.getIcon("apps-pagetree-page-default",c.sizes.large);let a;const u=t.setup.$carousel.closest(".modal"),d=u.find(".modal-footer").find('button[name="next"]');t.blurCancelStep(),t.lockNextStep(),t.lockPrevStep(),r.getAccessibleFormStorageFolders().length===0&&(a='<h5 class="form-section-headline">'+TYPO3.lang["formManager.newFormWizard.step1.noStorages"]+"</h5>",m.html(a),r.assert(!1,"No accessible form storage folders",1477506500)),a='<div class="card-container"><div class="card card-size-medium"><div class="card-header"><div class="card-icon">'+i+'</div><div class="card-header-body"><h2 class="card-title">'+TYPO3.lang["formManager.blankForm.label"]+'</h2><span class="card-subtitle">'+TYPO3.lang["formManager.blankForm.subtitle"]+'</span></div></div><div class="card-body"><p class="card-text">'+TYPO3.lang["formManager.blankForm.description"]+'</p></div><div class="card-footer"><button type="button" class="btn btn-default" data-inline="1" value="blank" data-identifier="newFormModeButton">'+o+" "+TYPO3.lang["formManager.blankForm.label"]+'</button></div></div><div class="card card-size-medium"><div class="card-header"><div class="card-icon">'+l+'</div><div class="card-header-body"><h2 class="card-title">'+TYPO3.lang["formManager.predefinedForm.label"]+'</h2><span class="card-subtitle">'+TYPO3.lang["formManager.predefinedForm.subtitle"]+'</span></div></div><div class="card-body"><p class="card-text">'+TYPO3.lang["formManager.predefinedForm.description"]+'</p></div><div class="card-footer"><button type="button" class="btn btn-default" data-inline="1" value="predefined" data-identifier="newFormModeButton">'+o+" "+TYPO3.lang["formManager.predefinedForm.label"]+"</button></div></div></div>",m.html(a),e(n.newFormModeButton,u).on("click",function(p){t.set("newFormMode",e(p.currentTarget).val()),t.next()}),d.on("click",async function(){m.html(e("<div />",{class:"text-center"}).append(await c.getIcon("spinner-circle",c.sizes.default,null,null)).prop("outerHTML"))})}),t.addSlide("new-form-step-2",TYPO3.lang["formManager.newFormWizard.step2.title"],"",b.notice,top.TYPO3.lang["wizard.progressStep.configure"],function(m,o){let l,i;t.lockNextStep(),t.unlockPrevStep();const a=t.setup.$carousel.closest(".modal"),u=a.find(".modal-footer").find('button[name="next"]'),d=r.getAccessibleFormStorageFolders();if(o.savePath||(t.set("savePath",d[0].value),t.set("savePathName",d[0].label)),d.length>1){i=e('<select class="new-form-save-path form-select" id="new-form-save-path" data-identifier="newFormSavePath" />');for(let f=0,P=d.length;f<P;++f){const w=new Option(d[f].label,d[f].value);e(i).append(w)}}const s=r.getPrototypes();r.assert(s.length>0,"No prototypes available",1477506501),o.prototypeName||(t.set("prototypeName",s[0].value),t.set("prototypeNameName",s[0].label));const p=e('<select class="new-form-prototype-name form-select" id="new-form-prototype-name" data-identifier="newFormPrototypeName" />');for(let f=0,P=s.length;f<P;++f){const w=new Option(s[f].label,s[f].value);e(p).append(w)}let g=r.getTemplatesForPrototype(s[0].value);r.assert(g.length>0,"No templates available",1477506502),o.templatePath||(t.set("templatePath",g[0].value),t.set("templatePathName",g[0].label));const M=e('<select class="new-form-template form-select" id="new-form-template" data-identifier="newFormTemplate" />');for(let f=0,P=g.length;f<P;++f){const w=new Option(g[f].label,g[f].value);e(M).append(w)}l="",o.newFormMode==="blank"?(l+='<h5 class="form-section-headline">'+TYPO3.lang["formManager.blankForm.label"]+"</h5>",t.set("templatePath","EXT:form/Resources/Private/Backend/Templates/FormEditor/Yaml/NewForms/BlankForm.yaml"),t.set("templatePathName",TYPO3.lang["formManager.blankForm.label"])):(l+='<h5 class="form-section-headline">'+TYPO3.lang["formManager.predefinedForm.label"]+"</h5>",s.length>1&&(l+='<div class="form-group"><label class="form-label" for="new-form-prototype-name">'+TYPO3.lang["formManager.form_prototype"]+"</label>"+e(p)[0].outerHTML+"</div>"),g.length>1&&(l+='<div class="form-group"><label class="form-label" for="new-form-template">'+TYPO3.lang["formManager.form_template"]+'</label><div class="form-description">'+TYPO3.lang["formManager.form_template_description"]+"</div>"+e(M)[0].outerHTML+"</div>")),l+='<div class="form-group"><label class="form-label" for="new-form-name">'+TYPO3.lang["formManager.form_name"]+'</label><div class="form-description">'+TYPO3.lang["formManager.form_name_description"]+"</div>",o.formName?(l+='<input class="form-control" id="new-form-name" data-identifier="newFormName" value="'+v.encodeHtml(o.formName)+'" />',setTimeout(function(){t.unlockNextStep()},200)):l+='<input class="form-control has-error" id="new-form-name" data-identifier="newFormName" />',l+="</div>",i&&(l+='<div class="form-group"><label class="form-label" for="new-form-save-path">'+TYPO3.lang["formManager.form_save_path"]+'</label><div class="form-description">'+TYPO3.lang["formManager.form_save_path_description"]+"</div>"+e(i)[0].outerHTML+"</div>"),m.html(l),o.savePath&&e(n.newFormSavePath,a).val(o.savePath),o.templatePath&&e(n.newFormTemplate,a).val(o.templatePath),s.length>1?e(n.newFormPrototypeName,a).focus():g.length>1&&e(n.newFormTemplate,a).focus();const N=function(){e(n.newFormTemplate,a).on("change",function(){t.set("templatePath",e(n.newFormTemplate+" option:selected",a).val()),t.set("templatePathName",e(n.newFormTemplate+" option:selected",a).text()),t.set("templatePathOnPrev",e(n.newFormTemplate+" option:selected",a).val())})};e(n.newFormPrototypeName,a).on("change",function(f){t.set("prototypeName",e(n.newFormPrototypeName+" option:selected",a).val()),t.set("prototypeNameName",e(n.newFormPrototypeName+" option:selected",a).text()),g=r.getTemplatesForPrototype(e(f.currentTarget).val()),e(n.newFormTemplate,a).off().empty();for(let P=0,w=g.length;P<w;++P){const O=new Option(g[P].label,g[P].value);e(n.newFormTemplate,a).append(O),t.set("templatePath",g[0].value),t.set("templatePathName",g[0].label)}N()}),N(),o.prototypeName&&(e(n.newFormPrototypeName,a).val(o.prototypeName),e(n.newFormPrototypeName,a).trigger("change"),o.templatePathOnPrev&&(e(n.newFormTemplate,a).find(S`option[value="${o.templatePathOnPrev}"]`).prop("selected",!0),e(n.newFormTemplate,a).trigger("change"))),e(n.newFormName,a).focus(),e(n.newFormName,a).on("keyup paste",function(f){e(f.currentTarget).val().length>0?(e(f.currentTarget).removeClass("has-error"),t.unlockNextStep(),t.set("formName",e(f.currentTarget).val()),"code"in f&&f.code==="Enter"&&t.triggerStepButton("next")):(e(f.currentTarget).addClass("has-error"),t.lockNextStep())}),e(n.newFormSavePath,a).on("change",function(){t.set("savePath",e(n.newFormSavePath+" option:selected",a).val()),t.set("savePathName",e(n.newFormSavePath+" option:selected",a).text())}),o.newFormMode!=="blank"&&!o.templatePathName&&t.set("templatePathName",e(n.newFormTemplate+" option:selected",a).text()),u.on("click",async function(){t.setup.forceSelection=!1,m.html(e("<div />",{class:"text-center"}).append(await c.getIcon("spinner-circle",c.sizes.default,null,null)).prop("outerHTML"))})}),t.addSlide("new-form-step-3",TYPO3.lang["formManager.newFormWizard.step3.title"],"",b.notice,TYPO3.lang["formManager.newFormWizard.step3.progressLabel"],async function(m,o){const l=await c.getIcon("actions-cog",c.sizes.small),i=await c.getIcon("actions-file-t3d",c.sizes.small),a=await c.getIcon("actions-tag",c.sizes.small),u=await c.getIcon("actions-database",c.sizes.small),s=t.setup.$carousel.closest(".modal").find(".modal-footer").find('button[name="next"]');let p='<h5 class="form-section-headline">'+TYPO3.lang["formManager.newFormWizard.step3.check"]+"</h5><p>"+TYPO3.lang["formManager.newFormWizard.step3.message"]+'</p><div class="alert alert-notice">';o.prototypeNameName&&(p+='<div class="row my-1"><div class="col col-sm-6">'+l+" "+TYPO3.lang["formManager.form_prototype"]+'</div><div class="col">'+v.encodeHtml(o.prototypeNameName)+"</div></div>"),o.templatePathName&&(p+='<div class="row my-1"><div class="col col-sm-6">'+i+" "+TYPO3.lang["formManager.form_template"]+'</div><div class="col">'+v.encodeHtml(o.templatePathName)+"</div></div>"),p+='<div class="row my-1"><div class="col col-sm-6">'+a+" "+TYPO3.lang["formManager.form_name"]+'</div><div class="col">'+v.encodeHtml(o.formName)+'</div></div><div class="row my-1"><div class="col col-sm-6">'+u+" "+TYPO3.lang["formManager.form_save_path"]+'</div><div class="col">'+v.encodeHtml(o.savePathName)+"</div></div></div>",m.html(p),s.focus(),s.on("click",async function(){t.setup.forceSelection=!1,m.html(e("<div />",{class:"text-center"}).append(await c.getIcon("spinner-circle",c.sizes.default,null,null)).prop("outerHTML"))})}),t.addFinalProcessingSlide(function(){e.post(r.getAjaxEndpoint("create"),{formName:t.setup.settings.formName,templatePath:t.setup.settings.templatePath,prototypeName:t.setup.settings.prototypeName,savePath:t.setup.settings.savePath},function(m){m.status==="success"?document.location=m.url:T.error(TYPO3.lang["formManager.newFormWizard.step4.errorTitle"],TYPO3.lang["formManager.newFormWizard.step4.errorMessage"]+" "+m.message),t.dismiss()}).fail(function(m,o,l){const i=new DOMParser,a=i.parseFromString(m.responseText,"text/html"),u=e(a.body);T.error(o,l,2),t.dismiss(),e(n.t3Logo,u).remove(),e(n.t3Footer,u).remove(),e(n.moduleBody).html(u.html())})}).then(function(){t.show()})})}function x(r){e(n.removeFormModalTrigger).on("click",function(h){const m=[];h.preventDefault();const o=e(h.currentTarget);m.push({text:TYPO3.lang["formManager.cancel"],active:!0,btnClass:"btn-default",name:"cancel",trigger:function(l,i){i.hideModal()}}),m.push({text:TYPO3.lang["formManager.remove_form"],active:!0,btnClass:"btn-danger",name:"createform",trigger:function(l,i){e.post(r.getAjaxEndpoint("delete"),{formPersistenceIdentifier:o.data("formPersistenceIdentifier")},function(a){a.status==="success"?document.location=a.url:T.error(a.title,a.message),i.hideModal()})}}),F.show(TYPO3.lang["formManager.remove_form_title"],TYPO3.lang["formManager.remove_form_message"].replace("{0}",o.data("formName")),b.error,m)})}function z(r){e(n.duplicateFormModalTrigger).on("click",function(h){h.preventDefault();const m=e(h.currentTarget);t.addSlide("duplicate-form-step-1",TYPO3.lang["formManager.duplicateFormWizard.step1.title"].replace("{0}",m.data("formName")),"",b.notice,top.TYPO3.lang["wizard.progressStep.configure"],function(o){let l,i;t.lockPrevStep(),t.lockNextStep();const a=t.setup.$carousel.closest(".modal"),u=a.find(".modal-footer").find('button[name="next"]'),d=r.getAccessibleFormStorageFolders();if(r.assert(d.length>0,"No accessible form storage folders",1477649539),t.set("formPersistenceIdentifier",m.data("formPersistenceIdentifier")),t.set("savePath",d[0].value),d.length>1){i=e('<select id="duplicate-form-save-path" class="form-select" data-identifier="duplicateFormSavePath" />');for(let s=0,p=d.length;s<p;++s){const g=new Option(d[s].label,d[s].value);e(i).append(g)}}l='<div class="duplicate-form-modal"><h2 class="h3 form-section-headline">'+TYPO3.lang["formManager.new_form_name"]+'</h2><div class="form-group"><label class="form-label for="duplicate-form-name">'+TYPO3.lang["formManager.form_name"]+'</label><div class="form-description">'+TYPO3.lang["formManager.form_name_description"]+'</div><div class="formengine-field-item t3js-formengine-field-item"><input id="duplicate-form-name" class="form-control has-error" data-identifier="duplicateFormName" /></div></div>',i&&(l+='<div class="form-group"><label class="form-label" for="duplicate-form-save-path">'+TYPO3.lang["formManager.form_save_path"]+'</label><div class="form-description">'+TYPO3.lang["formManager.form_save_path_description"]+'</div><div class="formengine-field-item t3js-formengine-field-item">'+e(i)[0].outerHTML+"</div></div>"),l+="</div>",o.html(l),e(n.duplicateFormName,a).focus(),e(n.duplicateFormName,a).on("keyup paste",function(s){const p=e(event.currentTarget);p.val().length>0?(p.removeClass("has-error"),t.unlockNextStep(),t.set("formName",p.val()),"code"in s&&s.code==="Enter"&&t.triggerStepButton("next")):(p.addClass("has-error"),t.lockNextStep())}),u.on("click",async function(){t.setup.forceSelection=!1,t.set("confirmationDuplicateFormName",m.data("formName")),d.length>1?(t.set("savePath",e(n.duplicateFormSavePath+" option:selected",a).val()),t.set("confirmationDuplicateFormSavePath",e(n.duplicateFormSavePath+" option:selected",a).text())):(t.set("savePath",d[0].value),t.set("confirmationDuplicateFormSavePath",d[0].label)),o.html(e("<div />",{class:"text-center"}).append(await c.getIcon("spinner-circle",c.sizes.default,null,null)).prop("outerHTML"))})}),t.addSlide("duplicate-form-step-2",TYPO3.lang["formManager.duplicateFormWizard.step2.title"],"",b.notice,TYPO3.lang["formManager.duplicateFormWizard.step2.progressLabel"],async function(o,l){const i=await c.getIcon("actions-file-t3d",c.sizes.small),a=await c.getIcon("actions-tag",c.sizes.small),u=await c.getIcon("actions-database",c.sizes.small);t.unlockPrevStep(),t.unlockNextStep();const s=t.setup.$carousel.closest(".modal").find(".modal-footer").find('button[name="next"]'),p='<h5 class="form-section-headline">'+TYPO3.lang["formManager.duplicateFormWizard.step2.check"]+"</h5><p>"+TYPO3.lang["formManager.newFormWizard.step3.message"]+'</p><div class="alert alert-notice"><div class="dropdown-table-row"><div class="dropdown-table-column dropdown-table-icon">'+i+'</div><div class="dropdown-table-column dropdown-table-title">'+TYPO3.lang["formManager.form_copied"]+'</div><div class="dropdown-table-column dropdown-table-value">'+v.encodeHtml(l.confirmationDuplicateFormName)+'</div></div><div class="dropdown-table-row"><div class="dropdown-table-column dropdown-table-icon">'+a+'</div><div class="dropdown-table-column dropdown-table-title">'+TYPO3.lang["formManager.form_name"]+'</div><div class="dropdown-table-column dropdown-table-value">'+v.encodeHtml(l.formName)+'</div></div><div class="dropdown-table-row"><div class="dropdown-table-column dropdown-table-icon">'+u+'</div><div class="dropdown-table-column dropdown-table-title">'+TYPO3.lang["formManager.form_save_path"]+'</div><div class="dropdown-table-column dropdown-table-value">'+v.encodeHtml(l.confirmationDuplicateFormSavePath)+"</div></div></div></div>";o.html(p),s.focus(),s.on("click",async function(){t.setup.forceSelection=!1,o.html(e("<div />",{class:"text-center"}).append(await c.getIcon("spinner-circle",c.sizes.default,null,null)).prop("outerHTML"))})}),t.addFinalProcessingSlide(function(){e.post(r.getAjaxEndpoint("duplicate"),{formName:t.setup.settings.formName,formPersistenceIdentifier:t.setup.settings.formPersistenceIdentifier,savePath:t.setup.settings.savePath},function(o){o.status==="success"?document.location=o.url:T.error(TYPO3.lang["formManager.duplicateFormWizard.step3.errorTitle"],TYPO3.lang["formManager.duplicateFormWizard.step3.errorMessage"]+" "+o.message),t.dismiss()}).fail(function(o,l,i){const a=new DOMParser,u=a.parseFromString(o.responseText,"text/html"),d=e(u.body);T.error(l,i,2),t.dismiss(),e(n.t3Logo,d).remove(),e(n.t3Footer,d).remove(),e(n.moduleBody).html(d.html())})}).then(function(){t.show()})})}function _(r){e(n.showReferences).on("click",h=>{h.preventDefault();const m=e(h.currentTarget),o=r.getAjaxEndpoint("references")+"&formPersistenceIdentifier="+m.data("formPersistenceIdentifier");e.get(o,async function(l){let i;const a=[];a.push({text:TYPO3.lang["formManager.cancel"],active:!0,btnClass:"btn-default",name:"cancel",trigger:function(s,p){p.hideModal()}});const u=l.references.length,d=await c.getIcon("actions-open",c.sizes.small);if(u>0){i='<h2 class="h3">'+TYPO3.lang["formManager.references.headline"].replace("{0}",v.encodeHtml(m.data("formName")))+'</h2><div class="table-fit"><table id="forms" class="table table-striped table-hover"><thead><tr><th class="col-icon"></th><th class="col-recordtitle">'+TYPO3.lang["formManager.table.field.title"]+"</th><th>"+TYPO3.lang["formManager.table.field.uid"]+'</th><th class="col-control nowrap"><span class="visually-hidden">'+TYPO3.lang["formManager.table.field._CONTROL_"]+"</span></th></tr></thead><tbody>";for(let s=0,p=l.references.length;s<p;++s)i+='<tr><td class="col-icon">'+l.references[s].recordIcon+'</td><td class="col-recordtitle"><a href="'+v.encodeHtml(l.references[s].recordEditUrl)+'" data-identifier="referenceLink">'+v.encodeHtml(l.references[s].recordTitle)+"</a></td><td>"+v.encodeHtml(l.references[s].recordUid)+'</td><td class="col-control"><div class="btn-group" role="group"><a href="'+v.encodeHtml(l.references[s].recordEditUrl)+'" data-identifier="referenceLink" class="btn btn-default" title="'+TYPO3.lang["formManager.btn.edit.title"]+'">'+d+"</a></div></td></tr>";i+="</tbody></table></div>"}else i="<div><h1>"+TYPO3.lang["formManager.references.title"].replace("{0}",v.encodeHtml(l.formPersistenceIdentifier))+"</h1></div><div>"+TYPO3.lang["formManager.no_references"]+"</div>";i=e(i),e(n.referenceLink,i).on("click",function(s){s.preventDefault(),F.currentModal.hideModal(),document.location=e(s.currentTarget).prop("href")}),F.show(TYPO3.lang["formManager.references.title"].replace("{0}",m.data("formName")),i,b.notice,a)}).fail(function(l,i,a){l.status!==0&&T.error(i,a,2)})})}function H(){const r=document.querySelector(n.formsTable);r!==null&&new Y(r)}function L(r){x(r),k(r),z(r),_(r),H()}export{L as bootstrap};
